{% extends "base.html" %}

{% block title %}Add New Test{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1>Add New Test Record</h1>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">New Testing Session</h5>
                    <p class="text-muted">Create a new test record for a completed item</p>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="completed_item_id" class="form-label">Completed Item *</label>
                                <select class="form-select" id="completed_item_id" name="completed_item_id" required>
                                    <option value="">Select completed item...</option>
                                    {% for item in completed_items %}
                                    <option value="{{ item.id }}" data-area-id="{{ item.production_area_id }}">
                                        {{ item.item_name }} ({{ item.completion_date.strftime('%Y-%m-%d') if item.completion_date else 'N/A' }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select the completed item to test</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="lab_id" class="form-label">Testing Laboratory *</label>
                                <select class="form-select" id="lab_id" name="lab_id" required>
                                    <option value="">Select laboratory...</option>
                                    {% for lab in laboratories %}
                                    <option value="{{ lab.id }}">
                                        {{ lab.name }} - {{ lab.location }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Choose the testing laboratory</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="conducted_by_worker_id" class="form-label">Lab Worker *</label>
                                <select class="form-select" id="conducted_by_worker_id" name="conducted_by_worker_id" required>
                                    <option value="">Select lab worker...</option>
                                    {% for worker in lab_workers %}
                                    <option value="{{ worker.employee_id }}" data-lab="{{ worker.lab_id }}">
                                        {{ worker.Employee.first_name }} {{ worker.Employee.last_name }} ({{ worker.specialization }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select the worker conducting the test</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="test_status" class="form-label">Test Status *</label>
                                <select class="form-select" id="test_status" name="test_status" required>
                                    <option value="in_progress">In Progress</option>
                                    <option value="passed">Passed</option>
                                    <option value="failed">Failed</option>
                                </select>
                                <div class="form-text">Current status of the test</div>
                            </div>
                        </div>

                        <div class="row mb-3">                            <div class="col-md-6">
                                <label for="test_start_date" class="form-label">Test Start Date *</label>
                                <input type="date" class="form-control" id="test_start_date" name="test_start_date" required>
                                <div class="form-text">When the test began</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="test_completion_date" class="form-label">Test Completion Date</label>
                                <input type="date" class="form-control" id="test_completion_date" name="test_completion_date">
                                <div class="form-text">Leave blank if test is still in progress</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="test_result" class="form-label">Test Result</label>
                            <textarea class="form-control" id="test_result" name="test_result" rows="3" 
                                      placeholder="Enter detailed test results..."></textarea>
                            <div class="form-text">Detailed description of test outcomes</div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Any additional observations or notes..."></textarea>
                            <div class="form-text">Optional notes about the testing process</div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fa fa-save"></i> Save Test Record
                                </button>
                                <a href="{{ url_for('main.tested_items') }}" class="btn btn-secondary">
                                    <i class="fa fa-times"></i> Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const labSelect = document.getElementById('lab_id');
    const workerSelect = document.getElementById('conducted_by_worker_id');
    const statusSelect = document.getElementById('test_status');
    const completionDateInput = document.getElementById('test_completion_date');
    
    // Filter lab workers based on selected laboratory
    labSelect.addEventListener('change', function() {
        const selectedLabId = this.value;
        const workerOptions = workerSelect.querySelectorAll('option');
        
        workerOptions.forEach(option => {
            if (option.value === '') {
                option.style.display = 'block';
                return;
            }
            
            const workerLabId = option.getAttribute('data-lab');
            if (!selectedLabId || workerLabId === selectedLabId) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
        
        // Reset worker selection if current selection is not valid for new lab
        if (workerSelect.value) {
            const currentOption = workerSelect.querySelector(`option[value="${workerSelect.value}"]`);
            if (currentOption && currentOption.style.display === 'none') {
                workerSelect.value = '';
            }
        }
    });
    
    // Handle completion date based on status
    statusSelect.addEventListener('change', function() {
        if (this.value === 'in_progress') {
            completionDateInput.value = '';
            completionDateInput.disabled = true;
        } else {
            completionDateInput.disabled = false;
            if (!completionDateInput.value) {
                completionDateInput.value = new Date().toISOString().split('T')[0];
            }
        }
    });
    
    // Validate dates
    const startDateInput = document.getElementById('test_start_date');
    startDateInput.addEventListener('change', function() {
        if (completionDateInput.value && completionDateInput.value < this.value) {
            completionDateInput.value = this.value;
        }
        completionDateInput.min = this.value;
    });
    
    completionDateInput.addEventListener('change', function() {
        if (this.value && this.value < startDateInput.value) {
            alert('Completion date cannot be earlier than start date');
            this.value = startDateInput.value;
        }
    });
      // Initial setup
    const today = new Date().toISOString().split('T')[0];
    startDateInput.value = today;  // Set today as default start date
    startDateInput.max = today;
    completionDateInput.max = today;
    
    // Trigger initial filtering
    labSelect.dispatchEvent(new Event('change'));
    statusSelect.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}
